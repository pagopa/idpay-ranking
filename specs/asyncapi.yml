asyncapi: 2.0.0
info:
  title: Ranking Service
  version: 1.0.0
  description: >-
    Its purpose is to notify allowed citizen notification and cancellation of an initiative
tags:
  - name: "notifyOnboardingRankingRequestError"
    description: "notify onboarding ranking request errors"
  - name: "notifyInitiativeBuildError"
    description: "notify initiative ranking build errors"
  - name: "notifyRankingOnboardingOutcomeError"
    description: "notify ranking onboarding outcome errors"
  - name: "deleteInitiative"
    description: "Delete the initiative"
  - name: "notifyRankingOnboardingOutcome"
    description: "notify ranking onboarding outcome"
  - name: "notifyEligibleFamilyMembers"
    description: "Invite eligible family members"
  - name: "notifyNotEligibleFamilyMembers"
    description: "Notify not eligible family members"
  - name: "onboardingRankingRequest"
    description: " onboarding ranking request information"
  - name: "initiativeRankingBuild"
    description: "initiative ranking build"
  - name: "generateFileRanking"
    description: "generate ranking file"
  - name: "onboardingRankingEnded"
    description: "onboarding ranking ended"

channels:
  ranking-onboarding-ranking-request-error:
    publish:
      message:
        $ref: '#/components/messages/RankingOnboardingRankingRequestError'
      bindings:
        kafka:
          topic: idpay-errors
      tags:
        - name: "notifyOnboardingRankingRequestError"
  ranking-initiative-build-rule-error:
    publish:
      message:
        $ref: '#/components/messages/RankingInitiativeBuildRuleError'
      bindings:
        kafka:
          topic: idpay-errors
      tags:
        - name: "notifyInitiativeBuildError"
  ranking-onboarding-outcome-error:
    publish:
      message:
        $ref: '#/components/messages/RankingOnboardingOutcomeError'
      bindings:
        kafka:
          topic: idpay-errors
      tags:
        - name: "notifyRankingOnboardingOutcomeError"
  ranking-delete-initiative-consumer:
    subscribe:
      message:
        $ref: '#/components/messages/QueueCommandOperationDTO'
      bindings:
        kafka:
          topic: idpay-commands
        tags:
          - name: "deleteInitiative"
  ranking-onboarding-outcome:
    publish:
      message:
        $ref: '#/components/messages/RankingOnboardingOutcome'
      bindings:
        kafka:
          topic: idpay-onboarding-outcome
      tags:
        - name: "notifyRankingOnboardingOutcome"
  ranking-invite-eligible-family-members:
    publish:
      message:
        $ref: '#/components/messages/RankingInviteEligibleFamilyMembers'
      bindings:
        kafka:
          topic: idpay-onboarding-outcome
      tags:
        - name: "notifyEligibleFamilyMembers"
  ranking-not-invite-eligible-family-members:
    publish:
      message:
        $ref: '#/components/messages/RankingNotInviteEligibleFamilyMembers'
      bindings:
        kafka:
          topic: idpay-onboarding-outcome
      tags:
        - name: "notifyNotEligibleFamilyMembers"
  ranking-onboarding-ranking-request-consumer:
    subscribe:
      message:
        $ref: '#/components/messages/RankingOnboardingRankingRequest'
      bindings:
        kafka:
          topic: idpay-onboarding-ranking-request
      tags:
        - name: "onboardingRankingRequest"
  ranking-initiative-build-rule-consumer:
    subscribe:
      message:
        $ref: '#/components/messages/RankingInitiativeBuildRule'
      bindings:
        kafka:
          topic: idpay-rule-update
      tags:
        - name: "initiativeRankingBuild"
  ranking-onboarding-file-built:
    publish:
      message:
        $ref: '#/components/messages/OnboardingRankingFileBuiltSendNotification'
      bindings:
        servicebus:
          topic: idpay-onboarding-request
      tags:
        - name: "generateFileRanking"
    subscribe:
      message:
        $ref: '#/components/messages/OnboardingRankingFileBuiltReceiveNotification'
      bindings:
        servicebus:
          topic: idpay-onboarding-request
      tags:
        - name: "generateFileRanking"
  ranking-onboarding-ranking-ended:
    publish:
      message:
        $ref: '#/components/messages/OnboardingRankingEndedSendNotification'
      bindings:
        servicebus:
          topic: idpay-onboarding-request
      tags:
        - name: "onboardingRankingEnded"
    subscribe:
      message:
        $ref: '#/components/messages/OnboardingRankingEndedReceiveNotification'
      bindings:
        servicebus:
          topic: idpay-onboarding-request
      tags:
        - name: "onboardingRankingEnded"


components:
  messages:
    RankingOnboardingRankingRequest:
      contentType: application/json
      description: >-
        Receive onboarding ranking request information
      summary: Receive onboarding information
      payload:
        $ref: "#/components/schemas/OnboardingRankingRequestDTO"
    RankingOnboardingRankingRequestError:
      contentType: application/json
      description: >-
        An error occurred during the onboarding ranking request
      summary: Informs of onboarding ranking request error
      payload:
        $ref: "#/components/schemas/OnboardingRankingRequestDTO"
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    RankingInitiativeBuildRule:
      contentType: application/json
      description: >-
        Receive initiative ranking build information
      summary: Initiative build rules info
      payload:
        $ref: "#/components/schemas/InitiativeBuildDTO"
    RankingInitiativeBuildRuleError:
      contentType: application/json
      description: >-
        An error occurred during initiative ranking build rules
      summary: Informs of onboarding initiative ranking build rules error
      payload:
        $ref: "#/components/schemas/InitiativeBuildDTO"
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    RankingOnboardingOutcomeError:
      contentType: application/json
      description: >-
        An error occurred during publishing of onboarding ranking result
      summary: Informs of onboarding ranking error during publishing of onboarding ranking result
      payload:
        $ref: "#/components/schemas/EvaluationRankingDTO"
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    RankingOnboardingOutcome:
      contentType: application/json
      description: >-
        Send information about onboarding request to outcome topic
      summary: Informs of onboarding onboarding request to outcome topic
      payload:
        $ref: "#/components/schemas/EvaluationRankingDTO"
    RankingInviteEligibleFamilyMembers:
      contentType: application/json
      description: Invite eligible family members. Send information about onboarding request to outcome topic.
      summary: Invite eligible family members to onboarding request outcome topic.
      payload:
        $ref: "#/components/schemas/EvaluationRankingDTO"
    RankingNotInviteEligibleFamilyMembers:
      contentType: application/json
      description: Notify not eligible family members. Send information about the onboarding request to the outcome topic.
      summary: Notify not eligible family members of onboarding request outcome.
      payload:
        $ref: "#/components/schemas/EvaluationRankingDTO"
    QueueCommandOperationDTO:
      contentType: application/json
      description: >-
        Event consumed from application when a delete initiative command has published
      summary: Delete documents of the initiative
      payload:
        $ref: "#/components/schemas/QueueCommandOperationDTO"
    OnboardingRankingFileBuiltSendNotification:
      contentType: application/json
      description: Channel for notifying the creation of onboarding ranking files
      summary: Notification of the creation of onboarding ranking files
      payload:
        $ref: "#/components/schemas/InitiativeConfig"
    OnboardingRankingFileBuiltReceiveNotification:
      contentType: application/json
      description: Channel for notifying the creation of onboarding ranking files
      summary: Receiving notification of the creation of onboarding ranking files
      payload:
        $ref: "#/components/schemas/InitiativeConfig"
    OnboardingRankingEndedSendNotification:
      contentType: application/json
      description: Channel for signaling the end of initiative rankings
      summary: Notification of the end of initiative rankings
      payload:
        $ref: "#/components/schemas/InitiativeConfig"
    OnboardingRankingEndedReceiveNotification:
      contentType: application/json
      description: Channel for signaling the end of initiative rankings
      summary: Receiving notification of the end of initiative rankings
      payload:
        $ref: "#/components/schemas/InitiativeConfig"
  schemas:
    InitiativeGeneralDTO:
      type: object
      properties:
        budgetCents:
          type: integer
          format: int64
          description: Budget of the initiative in cents
          example: 5000000
        beneficiaryType:
          type: string
          enum:
            - PF
            - PG
            - NF
          description: Type of beneficiary of the initiative
          example: PF
        beneficiaryBudgetCents:
          type: integer
          description: Budget of the beneficiary in cents
          example: 2000000
        rankingStartDate:
          type: string
          format: date
          description: Start date of the ranking
          example: "2024-06-01"
        rankingEndDate:
          type: string
          format: date
          description: End date of the ranking
          example: "2024-06-30"
        beneficiaryKnown:
          type: boolean
          description: Indicates whether the beneficiary is known
          example: true
        endDate:
          type: string
          format: date
          description: End date of the initiative
          example: "2024-12-31"
        rankingEnabled:
          type: boolean
          description: Indicates if ranking is enabled
          example: true
    QueueCommandOperationDTO:
      type: object
      properties:
        operationType:
          type: string
          description: Constant that define operation type
          example: DELETE_INITIATIVE
        entityId:
          type: string
          description: Entity to be handled with operationType
          example: 661626073785876cb5aa7601
        operationTime:
          type: string
          format: date-time
          description: operation time
          example: "2024-04-11T07:23:08.874869466"
    ErrorQueueHeader:
      type: object
      required:
        - srcType
        - srcServer
        - srcTopic
        - description
        - retryable
        - stacktrace
        - rootCauseClass
        - rootCauseMessage
      properties:
        srcType:
          type: string
          description: The type of the source of the error message.
          example: "kafka"
        srcServer:
          type: string
          description: The source server of the error message.
          example: "kafka-broker-1.example.com:9092"
        srcTopic:
          type: string
          description: The Kafka topic of the source of the error message.
          example: "idpay-onboarding-ranking-request"
        description:
          type: string
          description: Description of the error.
          example: "[ONBOARDING_RANKING_REQUEST] An error occurred handling onboarding ranking request"
        retryable:
          type: boolean
          description: Indicates whether the error is retryable or not.
        stacktrace:
          type: string
          description: The stack trace of the error.
          example: "RankingRuleBuilderException -> Error occurred during handling of ranking rule builder initiative"
        rootCauseClass:
          type: string
          description: Cause of the error.
          example: "com.example.RewardRuleBuilderException"
        rootCauseMessage:
          type: string
          description: Message of the error.
          example: "Error occurred during handling of reward rule builder initiative"
        kafka_messageKey:
          type: string
          description: The header containing the record key from the received message.
          example: 0
        applicationName:
          type: string
          description: The name of the application that generated the error.
          example: "idpay-ranking"
        group:
          type: string
          description: The Kafka group to which the error message belongs.
          example: "idpay-onboarding-ranking-request-consumer-group"
    OnboardingRankingRequestDTO:
      type: object
      description: Data Transfer Object for onboarding ranking requests
      properties:
        userId:
          type: string
          description: Identifier of the user
          example: 03055024-3cca-4574-9656-42951b6aac4f
        initiativeId:
          type: string
          description: Identifier of the initiative
          example: 6654208e4f47f940241a9ddc
        organizationId:
          type: string
          description: Id of the organization that created the initiative
          example: 390cea38-f2de-4bcb-a181-d6eef99fe528
        admissibilityCheckDate:
          type: string
          format: date-time
          description: Date and time of the admissibility check
          example: 2024-05-27T10:15:30
        criteriaConsensusTimestamp:
          type: string
          format: date-time
          description: Timestamp when criteria consensus was reached
          example: 2024-05-28T10:15:30
        rankingValue:
          type: integer
          format: int64
          description: Ranking value of the onboarding request
          example: 1000
        onboardingKo:
          type: boolean
          description: Indicates if the onboarding was unsuccessful
          example: false
        familyId:
          type: string
          description: Identifier for the family, if applicable
          example: 665419f13355223e0d03d858
        memberIds:
          type: array
          description: Set of member IDs associated with the family
          items:
            type: string
          example: [      "8f851a5f-9d19-4767-b23e-01aec5c18757",    "3ee83479-bc56-4293-8e66-00a7eae65b9d", "03055024-3cca-4574-9656-42951b6aac4f"]
          required:
            - userId
            - initiativeId
            - organizationId
            - admissibilityCheckDate
    InitiativeBuildDTO:
      type: object
      description: Data Transfer Object for initiative build
      properties:
        initiativeId:
          type: string
          description: Identifier of the initiative
          example: 661626073785876cb5aa7601
        initiativeName:
          type: string
          description: Name of the initiative
          example: Initiative Test
        organizationId:
          type: string
          description: Id of the organization that created the initiative
          example: 390cea38-f2de-4bcb-a181-d6eef99fe528
        organizationName:
          type: string
          description: Name of the organization
          example: Ente di test IdPay
        status:
          type: string
          description: Current status of the initiative
          example: PUBLISHED
        general:
          $ref: '#/components/schemas/InitiativeGeneralDTO'
        additionalInfo:
          $ref: '#/components/schemas/InitiativeAdditionalInfoDTO'
        beneficiaryRule:
          $ref: '#/components/schemas/InitiativeBeneficiaryRuleDTO'
        initiativeRewardType:
          type: string
          description: Type of reward associated with the initiative
          enum:
            - DISCOUNT
            - REFUND
          example: DISCOUNT
    InitiativeAdditionalInfoDTO:
      type: object
      description: Additional information of the initiative
      properties:
        logoFileName:
          type: string
          description: File name of the logo
          example: logo.png
    AutomatedCriteriaDTO:
      type: object
      description: Automated criteria for beneficiary selection
      properties:
        authority:
          type: string
          description: Authority issuing the criteria
          example: INPS
        code:
          type: string
          description: Code of the criteria
          example: ISEE
        field:
          type: string
          description: Field to which the criteria applies
          example: Year
        orderDirection:
          type: string
          description:  One of the possible order direction for the initiative criteria
          enum:
            - ASC
            - DESC
          example: ASC
    InitiativeBeneficiaryRuleDTO:
      type: object
      description: Beneficiary rule details of the initiative
      properties:
        automatedCriteria:
          type: array
          description: List of automated criteria for beneficiary selection
          items:
            $ref: '#/components/schemas/AutomatedCriteriaDTO'
    OnboardingRejectionReason:
      type: object
      description: Details for the reason of onboarding rejection
      properties:
        type:
          type: string
          description: Type of the rejection reason
          enum:
            - TECHNICAL_ERROR
            - CONSENSUS_MISSED
            - INVALID_REQUEST
            - BUDGET_EXHAUSTED
            - AUTOMATED_CRITERIA_FAIL
            - OUT_OF_RANKING
            - FAMILY_CRITERIA_KO
          example: FAMILY_CRITERIA_KO
        code:
          type: string
          description: Code representing the rejection reason
          example: FAMILY_CRITERIA_FAIL
        authority:
          type: string
          description: Authority that issued the rejection
          example: INPS
        authorityLabel:
          type: string
          description: Label for the authority
          example: Istituto Nazionale Previdenza Sociale
        detail:
          type: string
          description: Detailed description of the rejection reason
          example: Nucleo familiare non soddisfa i requisiti
    EvaluationRankingDTO:
      type: object
      description: Data Transfer Object for evaluation ranking
      properties:
        userId:
          type: string
          description: Identifier of the user
          example: 03055024-3cca-4574-9656-42951b6aac4f
        initiativeId:
          type: string
          description: Identifier of the initiative
          example: 6654242a4f47f940241a9df8
        initiativeName:
          type: string
          description: Name of the initiative
          example: Initiative Test
        initiativeEndDate:
          type: string
          format: date
          description: End date of the initiative
          example: 2024-12-31
        organizationId:
          type: string
          description: Identifier of the organization
          example: c326cac6-a38c-416c-a3c3-f6a407b77950
        organizationName:
          type: string
          description: Name of the organization
          example: Ente di test IdPay
        admissibilityCheckDate:
          type: string
          format: date-time
          description: Date and time of the admissibility check
          example: 2024-05-27T10:15:30
        criteriaConsensusTimestamp:
          type: string
          format: date-time
          description: Timestamp when criteria consensus was reached
          example: 2024-05-28T10:15:30
        status:
          type: string
          enum:
            - ONBOARDING_OK
            - ONBOARDING_KO
            - DEMANDED
          description: Current status of the evaluation
          example: ONBOARDING_KO
        onboardingRejectionReasons:
          type: array
          description: List of reasons for onboarding rejection
          items:
            $ref: '#/components/schemas/OnboardingRejectionReason'
          example:
            - type: FAMILY_CRITERIA_KO
              code: FAMILY_CRITERIA_FAIL
              detail: Nucleo familiare non soddisfa i requisiti
        beneficiaryBudgetCents:
          type: integer
          description: Budget allocated for the beneficiary in cents
          example: 500000
        initiativeRewardType:
          type: string
          description: Type of reward associated with the initiative
          example: DISCOUNT
        isLogoPresent:
          type: boolean
          description: Indicates if the logo is present
          example: true
        familyId:
          type: string
          description: Identifier for the family, if applicable
          example: 665419f13355223e0d03d858
      required:
        - userId
        - initiativeId
        - organizationId
        - admissibilityCheckDate
        - status
        - onboardingRejectionReasons
    RankingStatus:
      type: string
      enum:
        - WAITING_END
        - READY
        - PUBLISHING
        - COMPLETED
      description: The status of the ranking process.
      examples:
        - WAITING_END
        - READY
        - PUBLISHING
        - COMPLETED
    Order:
      type: object
      properties:
        fieldCode:
          type: string
          description: Code of the field used for ranking
          example: ISEE
        direction:
          type: string
          enum: [ASC, DESC]
          description: Direction of the sort order
          example: ASC
    BeneficiaryTypeEnum:
      type: string
      enum:
        - PF
        - PG
        - NF
      description: Type of beneficiaries for the initiative
      examples:
        - PF
        - PG
        - NF
    InitiativeConfig:
      type: object
      properties:
        initiativeId:
          type: string
          description: Identifier of the initiative
          example: 661626073785876cb5aa7601
        initiativeName:
          type: string
          description: Name of the initiative
          example: Initiative Test
        initiativeEndDate:
          type: string
          format: date
          description: End date of the initiative
          example: 2024-12-31
        initiativeRewardType:
          type: string
          description: Type of reward associated with the initiative
          example: DISCOUNT
        organizationId:
          type: string
          description: Id of the organization that created the initiative
          example: 390cea38-f2de-4bcb-a181-d6eef99fe528
        organizationName:
          type: string
          description: Name of the organization
          example: Ente di test IdPay
        initiativeStatus:
          type: string
          description: Current status of the initiative
          example: PUBLISHED
        rankingStartDate:
          type: string
          format: date
          description: Start date of the ranking
          example: "2024-06-01"
        rankingEndDate:
          type: string
          format: date
          description: End date of the ranking
          example: "2024-06-30"
        initiativeBudgetCents:
          type: integer
          format: int64
          description: Budget allocated for the initiative (in cents)
          example: 100000
        beneficiaryInitiativeBudgetCents:
          type: integer
          format: int64
          description: Budget allocated per beneficiary (in cents)
          example: 1000

        rankingStatus:
          $ref: "#/components/schemas/RankingStatus"
        size:
          type: integer
          format: int64
          description: Size of the ranking list
          example: 100
        rankingFields:
          type: array
          items:
            $ref: "#/components/schemas/Order"
        rankingFilePath:
          type: string
          description: Path to the ranking file
          example: 390cea38-f2de-4bcb-a181-d6eef99fe528/653a38fee12f564085a2f209/Testfunzio-ranking.csv.p7m
        rankingGeneratedTimestamp:
          type: string
          format: date-time
          description: Timestamp when the ranking file was generated
          example: 2023-10-26T10:02:51.740+00:00
        rankingPublishedTimestamp:
          type: string
          format: date-time
          description: Timestamp when the ranking file was published
          example: 2023-10-27T11:04:52.740+00:00
        totalEligibleOk:
          type: integer
          format: int64
          description: Total number of eligible beneficiaries (OK)
          example: 2
        totalEligibleKo:
          type: integer
          format: int64
          description: Total number of eligible beneficiaries (KO)
          example: 1
        totalOnboardingKo:
          type: integer
          format: int64
          description: Total number of onboarding requests that failed (KO)
          example: 0
        isLogoPresent:
          type: boolean
          description: Indicates if a logo is present for the initiative
        beneficiaryType:
          $ref: "#/components/schemas/BeneficiaryTypeEnum"