asyncapi: 2.0.0
info:
  title: Ranking Service
  version: 1.0.0
  description: >-
    Its purpose is to notify allowed citizen notification and cancellation of an initiative
tags:
  - name: "notifyOnboardingRankingRequestError"
    description: "notify onboarding ranking request errors"
  - name: "notifyInitiativeBuildError"
    description: "notify Initiative build errors"
  - name: "notifyRankingOnboardingOutcomeError"
    description: "notify ranking onboarding outcome errors"
channels:
  ranking-onboarding-ranking-request-error-consumer:
    publish:
      message:
        $ref: '#/components/messages/RankingOnboardingRankingRequest'
      bindings:
        kafka:
          topic: idpay-errors
      tags:
        - name: "notifyOnboardingRankingRequestError"
  ranking-initiative-build-rule-error-consumer:
    publish:
      message:
        $ref: '#/components/messages/RankingInitiativeBuildRuleError'
      bindings:
        kafka:
          topic: idpay-errors
      tags:
        - name: "notifyInitiativeBuildError"
  ranking-onboarding-outcome-error:
    publish:
      message:
        $ref: '#/components/messages/RankingOnboardingOutcomeError'
      bindings:
        kafka:
          topic: idpay-errors
      tags:
        - name: "notifyRankingOnboardingOutcomeError"

components:
  messages:
    RankingOnboardingRankingRequest:
      contentType: application/json
      description: >-
        An error occurred during the onboarding ranking request
      summary: Informs of onboarding ranking request error
      payload:
        $ref: "#/components/schemas/OnboardingRankingRequestDTO"
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    RankingInitiativeBuildRuleError:
      contentType: application/json
      description: >-
        An error occurred during initiative build rules
      summary: Informs of onboarding initiative build rules error
      payload:
        $ref: "#/components/schemas/InitiativeBuildDTO"
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    RankingOnboardingOutcomeError:
      contentType: application/json
      description: >-
        An error occurred during the notification of ranking onboarding
      summary: Informs of onboarding ranking error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    RewardTransactionNotifyError:
      contentType: application/json
      description: >-
        An error occurred during the notification of the reward transaction
      summary: Informs of reward transaction notification error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    HpanUpdateEvaluationError:
      contentType: application/json
      description: >-
        An error occurred during the evaluation of the HPAN update initiative
      summary: Informs of HPAN update evaluation error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    HpanInitiativeExecutionError:
      contentType: application/json
      description: >-
        An error occurred during the execution of the HPAN initiative
      summary: Informs of HPAN initiative execution error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    TrxResubmitterError:
      contentType: application/json
      description: >-
        Rivaluta le transazioni di storno arrivate prima di quelle dell'addebito
      summary: Rivaluta transazioni di storno
      headers:
        type: object
        properties:
          key:
            type: string
            description: "user id"
            example: "bcf3651c-d2d3-4998-81a9-5f24302ab674"
      payload:
        $ref: "#/components/schemas/TransactionDTO"
    UserCounterUnlockEvaluationError:
      contentType: application/json
      description: >-
        An error occurred during the evaluation of the user counter unlock transaction
      summary: Informs of user counter unlock evaluation error
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
    QueueCommandOperationDTO:
      contentType: application/json
      description: >-
        Event consumed from application when a delete initiative command has published
      summary: Delete documents of the initiative
      headers:
        $ref: "#/components/schemas/ErrorQueueHeader"
      payload:
        $ref: "#/components/schemas/QueueCommandOperationDTO"


  schemas:
    Reward:
      type: object
      properties:
        initiativeId:
          type: string
          description: Id of the initiative
          example: 661626073785876cb5aa7601
        organizationId:
          type: string
          description: Identifier of the organization associated with the initiative
          example: c326cac6-a38c-416c-a3c3-f6a407b77950
        providedRewardCents:
          type: integer
          format: int64
          description: reward calculated by rule engine
          example: 30000
        accruedRewardCents:
          type: integer
          format: int64
          description: reward updated after evaluation of any limits (budget, ecc...)
          example: 30000
        capped:
          type: boolean
          description: If the premium has been limited due to the beneficiary's budget
          example: false
        dailyCapped:
          type: boolean
          description: If the premium has been reached, it causes a daily limit
          example: false
        monthlyCapped:
          type: boolean
          description: If the premium has been reached, it causes a monthly limit
          example: false
        yearlyCapped:
          type: boolean
          description: If the premium has been reached, it causes an annual limit
          example: false
        weeklyCapped:
          type: boolean
          description: If the premium has been reached due to weekly limit
          example: false
        refund:
          type: boolean
          description: If the user has been refunded
          example: false
        completeRefund:
          type: boolean
          description: If the user has been fully refunded
          example: false
        counters:
          $ref: "#/components/schemas/Counter"

    Counter:
      type: object
      properties:
        trxNumber:
          type: integer
          format: int64
          description: transaction number
          example: 1
        totalRewardCents:
          type: integer
          format: int64
          description: total reward
          example: 30000
        totalAmountCents:
          type: integer
          format: int64
          description: total amount
          example: 900000
        exhaustedBudget:
          type: boolean
          description: if the budget is exhausted
        initiativeBudgetCents:
          type: integer
          format: int64
          description: initiative budget
          example: 30000
        version:
          type: integer
          format: int64
          description: sequence operation number
          example: 1

    TransactionDTO:
      type: object
      properties:
        idTrxAcquirer:
          type: string
          description: ID of the transaction from the acquirer
        acquirerCode:
          type: string
          description: Code of the acquirer
        trxDate:
          type: string
          format: date-time
          description: Date and time of the transaction
        hpan:
          type: string
          description: HPAN (Hashed PAN)
        operationType:
          type: string
          description: Type of operation
        circuitType:
          type: string
          description: Type of circuit
        idTrxIssuer:
          type: string
          description: ID of the transaction issuer
        correlationId:
          type: string
          description: Correlation ID
        amount:
          type: number
          description: Amount of the transaction
        amountCurrency:
          type: string
          description: Currency of the transaction amount
        mcc:
          type: string
          description: Merchant Category Code
        acquirerId:
          type: string
          description: ID of the acquirer
        merchantId:
          type: string
          description: ID of the merchant
        terminalId:
          type: string
          description: ID of the terminal
        bin:
          type: string
          description: Bank Identification Number
        senderCode:
          type: string
          description: Sender code
        fiscalCode:
          type: string
          description: Fiscal code
        vat:
          type: string
          description: VAT (Value Added Tax) number
        posType:
          type: string
          description: Type of point of sale
        par:
          type: string
          description: PAR (Parameter) value
        id:
          type: string
          description: ID of the transaction
        operationTypeTranscoded:
          type: string
          description: Transcoded type of operation
        rejectionReasons:
          type: array
          items:
            type: string
          description: List of rejection reasons
        amountCents:
          type: integer
          description: Amount of the transaction in cents
        effectiveAmountCents:
          type: integer
          description: Effective amount of the transaction in cents
        trxChargeDate:
          type: string
          format: date-time
          description: Date and time of the transaction charge
        refundInfo:
          $ref: "#/components/schemas/RefundInfo"
          description: Information about refund
        channel:
          type: string
          description: Channel of the transaction
        ruleEngineTopicPartition:
          type: integer
          description: Partition of the rule engine topic
        ruleEngineTopicOffset:
          type: integer
          description: Offset of the rule engine topic
        userId:
          type: string
          description: User ID
        brandLogo:
          type: string
          description: Brand logo
        brand:
          type: string
          description: Brand
        maskedPan:
          type: string
          description: Masked PAN
    TransactionProcessed:
      type: object
      properties:
        id:
          type: string
          description: ID of the transaction
        idTrxAcquirer:
          type: string
          description: ID of the transaction from the acquirer
        acquirerCode:
          type: string
          description: Code of the acquirer
        trxDate:
          type: string
          format: date-time
          description: Date and time of the transaction
        operationType:
          type: string
          description: Type of operation
        acquirerId:
          type: string
          description: ID of the acquirer
        userId:
          type: string
          description: User ID
        correlationId:
          type: string
          description: Correlation ID
        amount:
          type: number
          description: Amount of the transaction
        rewards:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Reward"
          description: Map of rewards
        status:
          type: string
          description: Status of the transaction
        rejectionReasons:
          type: array
          items:
            type: string
          description: List of rejection reasons
        initiativeRejectionReasons:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of initiative rejection reasons
        refundInfo:
          $ref: "#/components/schemas/RefundInfo"
          description: Information about refund
        initiatives:
          type: array
          items:
            type: string
          description: List of initiatives
        effectiveAmountCents:
          type: integer
          description: Effective amount of the transaction in cents
        amountCents:
          type: integer
          description: Amount of the transaction in cents
        trxChargeDate:
          type: string
          format: date-time
          description: Date and time of the transaction charge
        operationTypeTranscoded:
          type: string
          description: Transcoded type of operation
        elaborationDateTime:
          type: string
          format: date-time
          description: Date and time of transaction elaboration
        channel:
          type: string
          description: Channel of the transaction
        ruleEngineTopicPartition:
          type: integer
          description: Partition of the rule engine topic
        ruleEngineTopicOffset:
          type: integer
          description: Offset of the rule engine topic
    RefundInfo:
      type: object
      properties:
        previousTrxs:
          type: array
          items:
            $ref: "#/components/schemas/TransactionProcessed"
          description: List of previous transactions
        previousRewards:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/RefundInfo.PreviousReward"
          description: Map of previous rewards
    RefundInfo.PreviousReward:
      type: object
      properties:
        initiativeId:
          type: string
          description: ID of the initiative
        organizationId:
          type: string
          description: ID of the organization
        accruedRewardCents:
          type: integer
          description: Accrued reward in cents

    InitiativeReward2BuildDTO:
      type: object
      properties:
        initiativeId:
          type: string
          description: Constant that define operation type
          example: DELETE_INITIATIVE
        initiativeName:
          type: string
          description: The name of the initiative
          example: "initiativeTest"
        organizationId:
          type: string
          description: The id of the organization
          example: ""
        general:
          $ref: "#/components/schemas/InitiativeGeneralDTO"
        rewardRule:
          $ref: "#/components/schemas/InitiativeRewardRule"
        trxRule:
          $ref: "#/components/schemas/InitiativeTrxConditions"
        initiativeRewardType:
          $ref: "#/components/schemas/InitiativeRewardType"
    HpanInitiativeBulkDTO:
      type: object
      properties:
        userId:
          type: string
          description: User ID
        initiativeId:
          type: string
          description: Initiative ID
        infoList:
          type: array
          items:
            $ref: "#/components/schemas/PaymentMethodInfoDTO"
          description: List of payment method information
        operationType:
          type: string
          description: Type of operation
        operationDate:
          type: string
          format: date-time
          description: Date and time of the operation
        channel:
          type: string
          description: Channel of the operation
    HpanUpdateOutcomeDTO:
      type: object
      properties:
        initiativeId:
          type: string
          description: Initiative ID
        userId:
          type: string
          description: User ID
        hpanList:
          type: array
          items:
            type: string
          description: List of HPANs (Hashed PANs)
        rejectedHpanList:
          type: array
          items:
            type: string
          description: List of rejected HPANs
        operationType:
          type: string
          description: Type of operation
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the operation
    RewardTransactionDTO:
      allOf:
        - $ref: "#/components/schemas/TransactionDTO"
      type: object
      properties:
        status:
          type: string
          description: Transaction status
        initiativeRejectionReasons:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of initiative rejection reasons
        rewards:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Reward"
          description: Map of rewards
        initiatives:
          type: array
          items:
            type: string
          description: List of initiatives
        elaborationDateTime:
          type: string
          format: date-time
          description: Date and time of transaction elaboration
    PaymentMethodInfoDTO:
      type: object
      properties:
        hpan:
          type: string
          description: HPAN (Hashed PAN)
        maskedPan:
          type: string
          description: Masked PAN
        brandLogo:
          type: string
          description: Brand logo
        brand:
          type: string
          description: Brand
    InitiativeGeneralDTO:
      type: object
      properties:
        budgetCents:
          type: integer
          format: int64
          description: Budget of the initiative in cents
          example: 5000000
        beneficiaryType:
          type: string
          enum:
            - PF
            - PG
            - NF
          description: Type of beneficiary of the initiative
          example: PF
        beneficiaryBudgetCents:
          type: integer
          description: Budget of the beneficiary in cents
          example: 2000000
        rankingStartDate:
          type: string
          format: date
          description: Start date of the ranking
          example: "2024-06-01"
        rankingEndDate:
          type: string
          format: date
          description: End date of the ranking
          example: "2024-06-30"
        beneficiaryKnown:
          type: boolean
          description: Indicates whether the beneficiary is known
          example: true
        endDate:
          type: string
          format: date
          description: End date of the initiative
          example: "2024-12-31"
        rankingEnabled:
          type: boolean
          description: Indicates if ranking is enabled
          example: true
    InitiativeRewardRule:
      oneOf:
        - $ref: '#/components/schemas/RewardGroupsDTO'
        - $ref: '#/components/schemas/RewardValueDTO'
    RewardGroupsDTO:
      type: object
      description: DTO to define reward rule groups
      properties:
        rewardGroups:
          type: array
          description: List of reward rule groups
          items:
            $ref: '#/components/schemas/RewardGroupDTO'
    RewardGroupDTO:
      allOf:
        - $ref: '#/components/schemas/BaseRewardValue'
      type: object
      description: DTO for a single reward rule group
      properties:
        fromCents:
          type: integer
          description: Minimum value in cents
          example: 100
        toCents:
          type: integer
          description: Maximum value in cents
          example: 1000
        rewardValue:
          type: number
          description: Reward value
          example: 10
        rewardValueType:
          type: string
          description: Type of reward value
          example: PERCENTAGE
    RewardValueDTO:
      type: object
      description: DTO for a single reward value
      allOf:
        - $ref: '#/components/schemas/BaseRewardValue'
      properties:
        rewardValue:
          type: number
          description: Reward value
          example: 10
    BaseRewardValue:
      type: object
      description: Base class for reward value
      properties:
        rewardValue:
          type: number
          description: Reward value
          example: 10
        rewardValueType:
          type: string
          description: Type of reward value
          $ref: '#/components/schemas/RewardValueType'
    RewardValueType:
      type: string
      description: Indicates if the reward represents a fixed value or a percentage
      enum:
        - PERCENTAGE
        - ABSOLUTE
      example: PERCENTAGE
    InitiativeTrxConditions:
      type: object
      properties:
        daysOfWeek:
          $ref: "#/components/schemas/DayOfWeekDTO"
          description: Days of the week
        threshold:
          $ref: "#/components/schemas/ThresholdDTO"
          description: Threshold for transactions
        mccFilter:
          $ref: "#/components/schemas/MccFilterDTO"
          description: Merchant Category Code filter
        trxCount:
          $ref: "#/components/schemas/TrxCountDTO"
          description: Transaction count
        rewardLimits:
          type: array
          items:
            $ref: "#/components/schemas/RewardLimitsDTO"
          description: List of reward limits
    DayOfWeekDTO:
      type: array
      items:
        $ref: "#/components/schemas/DayOfWeekDTO.DayConfig"
      description: List of day configurations
    DayOfWeekDTO.DayConfig:
      type: object
      properties:
        daysOfWeek:
          type: array
          items:
            type: string
            enum: [ MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY ]
          description: Days of the week
        intervals:
          type: array
          items:
            $ref: "#/components/schemas/DayOfWeekDTO.Interval"
          description: List of intervals
    DayOfWeekDTO.Interval:
      type: object
      properties:
        startTime:
          type: string
          format: time
          description: Start time of the interval
        endTime:
          type: string
          format: time
          description: End time of the interval
    ThresholdDTO:
      type: object
      properties:
        fromCents:
          type: integer
          description: Minimum threshold in cents
        fromIncluded:
          type: boolean
          description: Indicates if the minimum threshold is inclusive
        toCents:
          type: integer
          description: Maximum threshold in cents
        toIncluded:
          type: boolean
          description: Indicates if the maximum threshold is inclusive
    MccFilterDTO:
      type: object
      properties:
        allowedList:
          type: boolean
          description: Indicates if the MCC filter represents an allowed list
        values:
          type: array
          items:
            type: string
          description: Set of MCC values
    TrxCountDTO:
      type: object
      properties:
        from:
          type: integer
          description: Minimum transaction count
        fromIncluded:
          type: boolean
          description: Indicates if the minimum transaction count is inclusive
        to:
          type: integer
          description: Maximum transaction count
        toIncluded:
          type: boolean
          description: Indicates if the maximum transaction count is inclusive
    RewardLimitsDTO:
      type: object
      properties:
        frequency:
          type: string
          enum: [ DAILY, WEEKLY, MONTHLY, YEARLY ]
          description: Frequency of reward limit
        rewardLimitCents:
          type: integer
          description: Reward limit in cents
    InitiativeRewardType:
      type: string
      enum: [ DISCOUNT, REFUND ]
      description: Type of initiative reward
    QueueCommandOperationDTO:
      type: object
      properties:
        operationType:
          type: string
          description: Constant that define operation type
          example: DELETE_INITIATIVE
        entityId:
          type: string
          description: Entity to be handled with operationType
          example: 661626073785876cb5aa7601
        operationTime:
          type: string
          format: date-time
          description: operation time
          example: "2024-04-11T07:23:08.874869466"
    ErrorQueueHeader:
      type: object
      required:
        - srcType
        - srcServer
        - srcTopic
        - description
        - retryable
        - stacktrace
        - rootCauseClass
        - rootCauseMessage
      properties:
        srcType:
          type: string
          description: The type of the source of the error message.
          example: "kafka"
        srcServer:
          type: string
          description: The source server of the error message.
          example: "kafka-broker-1.example.com:9092"
        srcTopic:
          type: string
          description: The Kafka topic of the source of the error message.
          example: "idpay-onboarding-ranking-request"
        description:
          type: string
          description: Description of the error.
          example: "[ONBOARDING_RANKING_REQUEST] An error occurred handling onboarding ranking request"
        retryable:
          type: boolean
          description: Indicates whether the error is retryable or not.
        stacktrace:
          type: string
          description: The stack trace of the error.
          example: "RankingRuleBuilderException -> Error occurred during handling of ranking rule builder initiative"
        rootCauseClass:
          type: string
          description: Cause of the error.
          example: "com.example.RewardRuleBuilderException"
        rootCauseMessage:
          type: string
          description: Message of the error.
          example: "Error occurred during handling of reward rule builder initiative"
        kafka_messageKey:
          type: string
          description: The header containing the record key from the received message.
          example: 0
        applicationName:
          type: string
          description: The name of the application that generated the error.
          example: "idpay-ranking"
        group:
          type: string
          description: The Kafka group to which the error message belongs.
          example: "idpay-onboarding-ranking-request-consumer-group"
    OnboardingRankingRequestDTO:
      type: object
      description: Data Transfer Object for onboarding ranking requests
      properties:
        userId:
          type: string
          description: Identifier of the user
          example: 03055024-3cca-4574-9656-42951b6aac4f
        initiativeId:
          type: string
          description: Identifier of the initiative
          example: 6654208e4f47f940241a9ddc
        organizationId:
          type: string
          description: Id of the organization that created the initiative
          example: 390cea38-f2de-4bcb-a181-d6eef99fe528
        admissibilityCheckDate:
          type: string
          format: date-time
          description: Date and time of the admissibility check
          example: 2024-05-27T10:15:30
        criteriaConsensusTimestamp:
          type: string
          format: date-time
          description: Timestamp when criteria consensus was reached
          example: 2024-05-28T10:15:30
        rankingValue:
          type: integer
          format: int64
          description: Ranking value of the onboarding request
          example: 1000
        onboardingKo:
          type: boolean
          description: Indicates if the onboarding was unsuccessful
          example: false
        familyId:
          type: string
          description: Identifier for the family, if applicable
          example: 665419f13355223e0d03d858
        memberIds:
          type: array
          description: Set of member IDs associated with the family
          items:
            type: string
          example: [      "8f851a5f-9d19-4767-b23e-01aec5c18757",    "3ee83479-bc56-4293-8e66-00a7eae65b9d", "03055024-3cca-4574-9656-42951b6aac4f"]
          required:
            - userId
            - initiativeId
            - organizationId
            - admissibilityCheckDate
    InitiativeBuildDTO:
      type: object
      description: Data Transfer Object for initiative build
      properties:
        initiativeId:
          type: string
          description: Identifier of the initiative
          example: 661626073785876cb5aa7601
        initiativeName:
          type: string
          description: Name of the initiative
          example: Initiative Test
        organizationId:
          type: string
          description: Id of the organization that created the initiative
          example: 390cea38-f2de-4bcb-a181-d6eef99fe528
        organizationName:
          type: string
          description: Name of the organization
          example: Ente di test IdPay
        status:
          type: string
          description: Current status of the initiative
          example: PUBLISHED
        general:
          $ref: '#/components/schemas/InitiativeGeneralDTO'
        additionalInfo:
          $ref: '#/components/schemas/InitiativeAdditionalInfoDTO'
        beneficiaryRule:
          $ref: '#/components/schemas/InitiativeBeneficiaryRuleDTO'
        initiativeRewardType:
          type: string
          description: Type of reward associated with the initiative
          enum:
            - DISCOUNT
            - REFUND
          example: DISCOUNT
    InitiativeAdditionalInfoDTO:
      type: object
      description: Additional information of the initiative
      properties:
        logoFileName:
          type: string
          description: File name of the logo
          example: logo.png
    AutomatedCriteriaDTO:
      type: object
      description: Automated criteria for beneficiary selection
      properties:
        authority:
          type: string
          description: Authority issuing the criteria
          example: INPS
        code:
          type: string
          description: Code of the criteria
          example: ISEE
        field:
          type: string
          description: Field to which the criteria applies
          example: Year
        orderDirection:
          type: string
          description:  One of the possible order direction for the initiative criteria
          enum:
            - ASC
            - DESC
          example: ASC
    InitiativeBeneficiaryRuleDTO:
      type: object
      description: Beneficiary rule details of the initiative
      properties:
        automatedCriteria:
          type: array
          description: List of automated criteria for beneficiary selection
          items:
            $ref: '#/components/schemas/AutomatedCriteriaDTO'